local lK    = 500
local lD    = 44.7214
local la    = 0.156109
local lTau  = 10
local lNum  = 355
local lXRFWR = {
{40, 0, 0, 0},
{40, 0.025641, 0, 0},
{40, 0.0512821, 0, 0},
{40, 0.0769231, 0, 0},
{40, 0.102564, 0, 0},
{40, 0.128205, 0, 0},
{40, 0.153846, 0, 0},
{40, 0.179487, 0, 0},
{40, 0.205128, 0, 0},
{40, 0.230769, 86.9282, -4.78032},
{38.6904, 0.25641, 90.0555, -2.66527},
{37.9942, 0.282051, 90.1027, -0.356722},
{37.3713, 0.307692, 88.163, 1.95609},
{36.7135, 0.333333, 74.7784, 4.0847},
{41.76, 0.358974, 26.9416, 5.32388},
{42.36, 0.384615, -80.1295, 4.81786},
{37.6691, 0.410256, -140.245, 1.7343},
{37.5365, 0.435897, -175.588, -2.48418},
{37.3745, 0.461538, -176.669, -7.0336},
{37.5487, 0.487179, -169.059, -11.4303},
{36.988, 0.512821, -177.438, -15.8725},
{37.0974, 0.538462, -197.504, -20.7474},
{36.9657, 0.564103, -202.869, -25.9367},
{36.1867, 0.589744, -177.008, -30.7479},
{41.28, 0.615385, -118.25, -34.5353},
{49.44, 0.641026, -62.9184, -36.8178},
{36.987, 0.666667, -22.4258, -37.7803},
{48.52, 0.692308, 21.7258, -37.7865},
{47.32, 0.717949, 74.5192, -36.6391},
{51.88, 0.74359, 119.829, -34.1947},
{47.4379, 0.769231, 143.385, -30.8433},
{39.2539, 0.794872, 151.536, -26.9979},
{41.5605, 0.820513, 152.763, -23.0844},
{41.8685, 0.846154, 148.931, -19.2187},
{38.2131, 0.871795, 143.724, -15.4901},
{47.6152, 0.897436, 137.756, -11.8706},
{45.64, 0.923077, 129.742, -8.44937},
{48.72, 0.948718, 115.863, -5.28794},
{44.1175, 0.974359, 105.344, -2.49166},
{40.0827, 1, 100.809, 0.0961078}
}

local lYRFWR = {
{40, 0, 0, 0},
{40, 0.025641, 0, 0},
{40, 0.0512821, 0, 0},
{40, 0.0769231, 0, 0},
{40, 0.102564, 0, 0},
{40, 0.128205, 0, 0},
{40, 0.153846, 0, 0},
{40, 0.179487, 0, 0},
{40, 0.205128, 0, 0},
{40, 0.230769, 20.7285, -1.08602},
{38.733, 0.25641, 20.4454, -0.544888},
{38.0163, 0.282051, 20.9287, -0.0290524},
{36.7408, 0.307692, 27.6926, 0.500526},
{36.1893, 0.333333, 58.2361, 1.52229},
{30.6309, 0.358974, 126.56, 4.29399},
{35.2805, 0.384615, 241.505, 9.62579},
{37.1011, 0.410256, 324.168, 17.26},
{34.4688, 0.435897, 325.257, 25.6789},
{32.5448, 0.461538, 269.163, 32.9378},
{43.2, 0.487179, 111.898, 38.1747},
{47.4, 0.512821, -33.2723, 39.4232},
{49.44, 0.538462, -145.502, 37.324},
{37.7821, 0.564103, -177.487, 33.0571},
{37.6981, 0.589744, -193.498, 28.2127},
{37.5045, 0.615385, -183.259, 23.3861},
{37.7404, 0.641026, -164.553, 18.9808},
{37.566, 0.666667, -151.675, 14.9683},
{37.4986, 0.692308, -137.685, 11.2846},
{46.32, 0.717949, -112.087, 8.05894},
{40.08, 0.74359, -81.0122, 5.50795},
{50.48, 0.769231, -55.3252, 3.71005},
{37.6707, 0.794872, -43.1207, 2.48444},
{37.7482, 0.820513, -32.1341, 1.55236},
{37.6465, 0.846154, -26.6733, 0.819795},
{37.6216, 0.871795, -23.7871, 0.176405},
{41.88, 0.897436, -16.5983, -0.364318},
{39.1543, 0.923077, -6.91613, -0.617004},
{40.5181, 0.948718, 0.994222, -0.669858},
{44.44, 0.974359, 9.41909, -0.516592},
{40.0828, 1, 15.3509, -0.12527}
}

local lWRFWR = {
{40, 0, 0, 0},
{40, 0.025641, 0, 0},
{40, 0.0512821, 0, 0},
{40, 0.0769231, 0, 0},
{40, 0.102564, 0, 0},
{40, 0.128205, 0, 0},
{40, 0.153846, 0, 0},
{40, 0.179487, 0, 0},
{40, 0.205128, 0, 0},
{40, 0.230769, 2.77913, -0.155356},
{38.7293, 0.25641, 3.61064, -0.114182},
{38.0237, 0.282051, 3.81332, -0.0250315},
{37.6726, 0.307692, 3.7253, 0.0729503},
{37.5287, 0.333333, 3.32136, 0.16427},
{37.5371, 0.358974, 2.7244, 0.240254},
{37.5522, 0.384615, 2.09255, 0.299551},
{37.5684, 0.410256, 2.05757, 0.351378},
{37.6035, 0.435897, 2.28116, 0.408782},
{37.5602, 0.461538, 1.08971, 0.451226},
{49.36, 0.487179, -2.57379, 0.439019},
{45.96, 0.512821, -5.81281, 0.329285},
{46.6391, 0.538462, -6.54541, 0.165496},
{48, 0.564103, -3.75351, 0.0239633},
{37.5839, 0.589744, -1.88897, -0.0404463},
{37.6016, 0.615385, -0.795079, -0.0701692},
{37.6875, 0.641026, -0.517496, -0.0857814},
{37.5995, 0.666667, -0.767297, -0.102057},
{37.5976, 0.692308, -1.11146, -0.12788},
{37.6783, 0.717949, -0.680424, -0.151029},
{37.7233, 0.74359, 0.188596, -0.155022},
{37.7276, 0.769231, 0.658744, -0.142073},
{37.6825, 0.794872, 0.656314, -0.125015},
{37.7654, 0.820513, 0.571461, -0.109396},
{37.6451, 0.846154, 0.0619986, -0.101402},
{38.781, 0.871795, -0.676073, -0.111061},
{37.7663, 0.897436, -0.739066, -0.130305},
{37.6899, 0.923077, -0.257809, -0.142861},
{46.2, 0.948718, 1.21471, -0.136128},
{39.7533, 0.974359, 2.26315, -0.086828},
{47.64, 1, 3.16455, -0.00699571}
}

function RoundToPenalty(task)
	local lastCycle = 0
	local calCnt = 0
	local startP
	local endP
	local startDir
	local endDir
	local mirrorFlag

	execute = function(runner)
		if type(task.pos) == "function" then
			endP = task.pos()
		else
			endP = task.pos
		end

		if type(task.dir) == "function" then
			endDir = task.dir(runner)
		else
			endDir = task.dir
		end

		if vision:Cycle() - lastCycle > 6 or lastCycle == 0 then
			calCnt = 0
			mirrorFlag = ball.antiY()
			startP = CGeoPoint:new_local(player.posX(runner), player.posY(runner))
			startDir = player.dir(runner)
		end

		lastCycle = vision:Cycle()
		local stepX = endP:x() - startP:x()
		local stepY = (endP:y() - startP:y())*mirrorFlag
		local stepDir = (endDir - startDir)*mirrorFlag

		local posX = learn.calRFWRRes(calCnt, lXRFWR, la, lTau, lK, 0, stepX,   lNum)
		local posY = learn.calRFWRRes(calCnt, lYRFWR, la, lTau, lK, 0, stepY,   lNum)
		local posW = learn.calRFWRRes(calCnt, lWRFWR, la, lTau, lK, 0, stepDir, lNum)
			
		calCnt = calCnt + 1
		return SimpleGotoPos(runner, posX+startP:x(), posY*mirrorFlag+startP:y(), Utils.Normalize(posW*mirrorFlag+startDir), 0)
	end

	matchPos = function()
		if type(task.pos) == "function" then
			mpos = task.pos()
		else
			mpos = task.pos
		end
		return mpos
	end

	return execute, matchPos
end

gSkillTable.CreateSkill{
	name = "RoundToPenalty",
	execute = function (self)
		print("This is in learn skill"..self.name)
	end
}
